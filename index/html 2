<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Mothma Design AI</title>
    <!-- Підключення шрифтів -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #F9F8F4; /* Фірмовий бежевий */
            --text-main: #1A1A1A;
            --accent-font: 'Playfair Display', serif;
            --body-font: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--body-font);
        }

        h1, h2, h3, .brand-font {
            font-family: var(--accent-font);
        }

        /* Стилізація скролбару */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #D1D1D1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #A0A0A0;
        }

        /* Стилізація повідомлень */
        .message-bubble {
            padding: 1.5rem;
            border-radius: 4px; /* Більш "квадратний" дизайн як на фото */
            margin-bottom: 1.5rem;
            line-height: 1.6;
            font-weight: 300;
            position: relative;
        }

        .user-message {
            background-color: #Eaeaea;
            align-self: flex-end;
            margin-left: 15%;
            border-bottom-right-radius: 0;
        }

        .bot-message {
            background-color: #FFFFFF;
            border: 1px solid #E5E5E5;
            margin-right: 5%;
            border-bottom-left-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        /* Стилізація згенерованих планів (SVG) */
        .plan-container {
            background: white;
            padding: 20px;
            border: 1px solid #000;
            margin-top: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
        }
        
        .plan-container svg {
            max-width: 100%;
            height: auto;
            stroke: #000;
            stroke-width: 1.5px;
            font-family: monospace;
        }

        /* Input Area */
        .input-wrapper {
            background: rgba(249, 248, 244, 0.9);
            backdrop-filter: blur(8px);
            border-top: 1px solid #E5E5E5;
        }

        .custom-input {
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-size: 1rem;
            max-height: 120px;
        }

        /* Перемикач режимів */
        .mode-btn {
            cursor: pointer;
            padding-bottom: 2px;
            transition: all 0.3s;
            opacity: 0.4;
        }
        .mode-btn.active {
            opacity: 1;
            border-bottom: 1px solid currentColor;
        }

        /* Анімація друку */
        .typing span {
            content: '';
            animation: blink 1.5s infinite;
            fill: black;
        }
        @keyframes blink {
            0% { opacity: .2; }
            20% { opacity: 1; }
            100% { opacity: .2; }
        }

        /* Зображення */
        .img-preview {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="flex justify-between items-end px-8 py-6 border-b border-gray-200 bg-[#F9F8F4] z-10">
        <div>
            <div class="brand-font text-3xl italic font-semibold tracking-tight">Mon Mothma.</div>
            <div class="text-xs uppercase tracking-widest text-gray-500 mt-1">Design Bureau AI</div>
        </div>
        
        <div class="flex gap-8 brand-font text-sm">
            <div id="btn-fast" class="mode-btn active" onclick="setMode('fast')">ШВИДКА ВІДПОВІДЬ</div>
            <div id="btn-reasoned" class="mode-btn" onclick="setMode('reasoned')">ПОМІРКОВАНА</div>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-8 flex flex-col">
        <!-- Welcome Message -->
        <div class="bot-message message-bubble max-w-2xl">
            <h3 class="brand-font text-xl mb-3 italic">Вітаю.</h3>
            <p>Я AI-асистент бюро Mon Mothma. Я допоможу вам з плануванням простору та декором.</p>
            <ul class="list-disc pl-5 mt-2 space-y-1 text-sm text-gray-600">
                <li>Завантажте фото кімнати, щоб я підказав, куди поставити вазу.</li>
                <li>Попросіть створити план ("Намалюй план кухні 3x4м").</li>
                <li>Запитайте про стилістику чи поєднання кольорів.</li>
            </ul>
        </div>
    </main>

    <!-- Footer / Input -->
    <footer class="input-wrapper px-8 py-6">
        <div class="max-w-4xl mx-auto w-full">
            
            <!-- File Previews -->
            <div id="preview-area" class="flex gap-2 mb-3 empty:hidden"></div>

            <div class="relative flex items-end gap-3 bg-white p-4 rounded-lg border border-gray-300 shadow-sm focus-within:ring-1 focus-within:ring-gray-400 transition-all">
                
                <!-- Upload Button -->
                <button onclick="document.getElementById('file-input').click()" class="text-gray-400 hover:text-black transition-colors pb-1" title="Додати фото/файл">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                </button>
                <input type="file" id="file-input" class="hidden" multiple accept="image/*" onchange="handleFiles(event)">

                <!-- Text Input -->
                <textarea id="user-input" rows="1" class="custom-input w-full font-light" placeholder="Опишіть задачу (наприклад: план кімнати 5x4)..." onkeydown="handleEnter(event)"></textarea>

                <!-- Send Button -->
                <button onclick="sendMessage()" id="send-btn" class="bg-black text-white rounded p-2 hover:bg-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </footer>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- CONFIG ---
        const API_KEY = "AIzaSyAxwQLxyKu5qjDgCkxkcfIKKGB2zSTq-m8";
        const genAI = new GoogleGenerativeAI(API_KEY);
        
        // System Prompt: Critical for style and SVG generation
        const SYSTEM_PROMPT = `
        Ти - професійний архітектор та дизайнер інтер'єру студії "Mon Mothma". 
        Стиль спілкування: вишуканий, професійний, лаконічний, українською мовою.

        ФУНКЦІОНАЛ:
        1. Якщо користувач просить "ПЛАН", "СХЕМУ", "РОЗСТАНОВКУ" або питає "ЯКИЙ ВИГЛЯД МАТИМЕ":
           - Ти ОБОВ'ЯЗКОВО маєш згенерувати SVG код.
           - Цей SVG має бути чорно-білим кресленням (blueprint style).
           - Фон білий, лінії чорні.
           - Обов'язково додай цифрові підписи розмірів (наприклад "3.5m").
           - SVG код має починатися з <svg ...> і закінчуватися </svg>.
           - Не використовуй markdown (\\\`\\\`\\\`xml) для SVG, просто пиши чистий тег <svg> у відповідь, або обгорни його спеціальним маркером [SVG_START] та [SVG_END].
        
        2. Якщо користувач завантажує фото:
           - Проаналізуй його з точки зору композиції та дизайну.
           - Дай конкретну пораду щодо інтеграції об'єктів.

        3. Не пиши зайвих вступів. Одразу до справи.
        `;

        // State
        let currentMode = 'fast';
        let attachments = [];

        // UI Functions
        window.setMode = (mode) => {
            currentMode = mode;
            document.getElementById('btn-fast').classList.toggle('active', mode === 'fast');
            document.getElementById('btn-reasoned').classList.toggle('active', mode === 'reasoned');
        };

        window.handleFiles = (e) => {
            const files = [...e.target.files];
            const previewArea = document.getElementById('preview-area');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    // Visual preview
                    const img = document.createElement('img');
                    img.src = evt.target.result;
                    img.className = 'img-preview shadow-sm';
                    previewArea.appendChild(img);

                    // Data for API
                    attachments.push({
                        inlineData: {
                            data: evt.target.result.split(',')[1],
                            mimeType: file.type
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        };

        window.handleEnter = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            // Auto resize
            e.target.style.height = 'auto';
            e.target.style.height = e.target.scrollHeight + 'px';
        };

        window.sendMessage = async () => {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const chat = document.getElementById('chat-container');
            
            if (!text && attachments.length === 0) return;

            // 1. Render User Message
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message message-bubble flex flex-col';
            let userHtml = `<p>${text.replace(/\n/g, '<br>')}</p>`;
            if (attachments.length > 0) {
                userHtml += `<div class="text-xs text-gray-500 mt-2 flex items-center gap-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg> ${attachments.length} файл(ів)</div>`;
            }
            userDiv.innerHTML = userHtml;
            chat.appendChild(userDiv);

            // Clear inputs
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('preview-area').innerHTML = '';
            const currentAttachments = [...attachments];
            attachments = [];
            
            // Scroll
            chat.scrollTop = chat.scrollHeight;

            // 2. Loading Indicator
            const loader = document.createElement('div');
            loader.className = 'bot-message message-bubble typing';
            loader.innerHTML = '<span class="text-2xl">...</span>';
            chat.appendChild(loader);

            try {
                // 3. API Call
                const model = genAI.getGenerativeModel({ 
                    model: "gemini-1.5-flash",
                    systemInstruction: SYSTEM_PROMPT
                });

                const prompt = currentMode === 'reasoned' 
                    ? text + "\n(Проведи детальний аналіз, поясни рішення, врахуй ергономіку)."
                    : text;

                const result = await model.generateContent({
                    contents: [{ role: "user", parts: [{ text: prompt }, ...currentAttachments] }],
                    generationConfig: {
                        temperature: currentMode === 'fast' ? 0.3 : 0.7
                    }
                });

                const responseText = result.response.text();

                // 4. Render Bot Response
                chat.removeChild(loader);
                
                const botDiv = document.createElement('div');
                botDiv.className = 'bot-message message-bubble max-w-3xl w-full';

                // Process Markdown and SVG
                // Logic: Extract SVG blocks, render them, and render the rest as Markdown
                
                // Temporary placeholder for SVG extraction
                let processedText = responseText;
                const svgs = [];
                
                // Regex to find SVG blocks (handling both ```svg wrapper and raw <svg>)
                processedText = processedText.replace(/```xml\s*(<svg[\s\S]*?<\/svg>)\s*```/gi, '$1');
                processedText = processedText.replace(/```svg\s*(<svg[\s\S]*?<\/svg>)\s*```/gi, '$1');
                
                // Render SVG logic
                const renderContent = (rawText) => {
                    // Check if there is SVG tag
                    if (rawText.includes('<svg')) {
                        // Split by SVG tag to separate text and image
                        const parts = rawText.split(/(<svg[\s\S]*?<\/svg>)/gi);
                        return parts.map(part => {
                            if (part.trim().startsWith('<svg')) {
                                return `<div class="plan-container">${part}</div>`;
                            } else {
                                return marked.parse(part);
                            }
                        }).join('');
                    } else {
                        return marked.parse(rawText);
                    }
                };

                botDiv.innerHTML = renderContent(processedText);
                chat.appendChild(botDiv);

            } catch (err) {
                chat.removeChild(loader);
                const errDiv = document.createElement('div');
                errDiv.className = 'bot-message message-bubble text-red-800 bg-red-50';
                errDiv.innerText = "Помилка: " + err.message;
                chat.appendChild(errDiv);
            }
            
            chat.scrollTop = chat.scrollHeight;
        };
    </script>
</body>
</html>
